---
import BaseLayout from '../layouts/BaseLayout.astro';
import fs from 'node:fs';
import path from 'node:path';

const base = import.meta.env.BASE_URL;

// Load model registry at build time
const jsonPath = path.join(process.cwd(), 'src/data/model-registry.json');
const modelData = JSON.parse(fs.readFileSync(jsonPath, 'utf-8'));
const models = modelData.models;
const updatedAt = modelData.updated_at;
---

<BaseLayout title="Model Registry - CUNY AI Lab">
  <!-- Hero Section -->
  <section class="relative pt-24 pb-10 lg:pt-28 lg:pb-12">
    <div class="absolute inset-0 bg-gradient-to-b from-cuny-blue via-cuny-blue to-vibrant-900"></div>
    <div class="absolute inset-0 opacity-[0.03]" style="background-image: url('data:image/svg+xml,%3Csvg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cg fill=\"%23ffffff\" fill-opacity=\"1\"%3E%3Cpath d=\"M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
      <h1 class="text-4xl md:text-5xl font-bold font-display text-white tracking-tight">Model Registry</h1>
      <p class="mt-4 text-vibrant-200 text-lg max-w-2xl">
        Auditable AI models curated for teaching and research. All models are accessed through zero-retention providers.
      </p>
      <p class="mt-2 text-vibrant-300/70 text-sm">Last updated: {updatedAt}</p>
    </div>
  </section>

  <!-- Filters Section -->
  <section class="py-6 bg-white border-b border-gray-100 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
        <!-- Search -->
        <div class="relative flex-1 max-w-md">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input
            type="text"
            id="search-input"
            placeholder="Search models or vendors..."
            class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-vibrant-500 focus:border-vibrant-500 transition-all bg-neutral-cream/50"
          />
        </div>

        <!-- Filter Pills -->
        <div class="flex flex-wrap gap-2">
          <button data-filter="open_weights" class="filter-btn px-4 py-2 rounded-full text-sm font-medium border border-gray-200 bg-white text-gray-600 hover:border-vibrant-500 hover:text-vibrant-600 transition-all">
            Open Weights
          </button>
          <button data-filter="vision" class="filter-btn px-4 py-2 rounded-full text-sm font-medium border border-gray-200 bg-white text-gray-600 hover:border-vibrant-500 hover:text-vibrant-600 transition-all">
            Vision
          </button>
          <button data-filter="tool_use" class="filter-btn px-4 py-2 rounded-full text-sm font-medium border border-gray-200 bg-white text-gray-600 hover:border-vibrant-500 hover:text-vibrant-600 transition-all">
            Tool Use
          </button>
          <button data-filter="long_context" class="filter-btn px-4 py-2 rounded-full text-sm font-medium border border-gray-200 bg-white text-gray-600 hover:border-vibrant-500 hover:text-vibrant-600 transition-all">
            Long Context
          </button>
        </div>

        <!-- Results count -->
        <div id="results-count" class="text-sm text-gray-500 ml-auto">
          {models.length} models
        </div>
      </div>
    </div>
  </section>

  <!-- Models Grid -->
  <section class="py-10 bg-neutral-cream min-h-[60vh]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div id="models-grid" class="grid gap-5 md:grid-cols-2 lg:grid-cols-3">
        {models.map((model: any) => (
          <article
            class="model-card group bg-white rounded-2xl border border-gray-100 overflow-hidden hover:shadow-xl hover:border-vibrant-200 transition-all duration-300"
            data-name={model.display_name.toLowerCase()}
            data-vendor={model.vendor.toLowerCase()}
            data-tags={model.tags.join(',')}
            data-open-weights={model.open_weights === true ? 'true' : 'false'}
            data-vision={model.capabilities.vision === true ? 'true' : 'false'}
            data-tool-use={model.capabilities.tool_calling === true ? 'true' : 'false'}
            data-long-context={model.context_window_tokens >= 100000 ? 'true' : 'false'}
          >
            <!-- Card Header -->
            <div class="p-5 pb-3">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <h3 class="font-bold text-lg text-neutral-stone font-display group-hover:text-vibrant-600 transition-colors">
                    {model.display_name}
                  </h3>
                  <p class="text-sm text-gray-500 mt-0.5">{model.vendor}</p>
                </div>
                <div class="flex-shrink-0">
                  {model.open_weights === true && (
                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-green-100 text-green-700">
                      Open
                    </span>
                  )}
                </div>
              </div>

              <!-- Badges -->
              <div class="flex flex-wrap gap-1.5 mt-3">
                {model.ui_badges.map((badge: string) => (
                  <span class={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${
                    badge.includes('Vision') ? 'bg-purple-100 text-purple-700' :
                    badge.includes('Tool') ? 'bg-blue-100 text-blue-700' :
                    badge.includes('context') ? 'bg-amber-100 text-amber-700' :
                    badge.includes('Open') ? 'bg-green-100 text-green-700' :
                    badge.includes('Reasoning') ? 'bg-indigo-100 text-indigo-700' :
                    'bg-gray-100 text-gray-600'
                  }`}>
                    {badge}
                  </span>
                ))}
              </div>
            </div>

            <!-- Specs Bar -->
            <div class="px-5 py-3 bg-neutral-cream/50 border-y border-gray-100 flex items-center gap-4 text-xs text-gray-500">
              <div class="flex items-center gap-1.5">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                <span>
                  {model.parameters.total_b}B
                  {model.parameters.active_b && ` / ${model.parameters.active_b}B active`}
                </span>
              </div>
              <div class="flex items-center gap-1.5">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
                <span>{(model.context_window_tokens / 1000).toFixed(0)}K context</span>
              </div>
              {model.parameters.architecture !== 'unknown' && (
                <div class="flex items-center gap-1.5">
                  <span class="text-gray-400">{model.parameters.architecture}</span>
                </div>
              )}
            </div>

            <!-- Expandable Details -->
            <div class="details-panel hidden">
              <div class="p-5 pt-4 space-y-4 border-t border-gray-100 bg-white">
                <!-- Best For -->
                <div>
                  <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Best For</h4>
                  <ul class="space-y-1.5">
                    {model.best_for.map((item: string) => (
                      <li class="flex items-start gap-2 text-sm text-gray-600">
                        <svg class="w-4 h-4 text-vibrant-500 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4" />
                        </svg>
                        <span>{item}</span>
                      </li>
                    ))}
                  </ul>
                </div>

                <!-- Strengths -->
                <div>
                  <h4 class="text-xs font-semibold text-green-600 uppercase tracking-wider mb-2">Strengths</h4>
                  <ul class="space-y-1">
                    {model.strengths.map((item: string) => (
                      <li class="text-sm text-gray-600 flex items-start gap-2">
                        <span class="text-green-500 font-bold flex-shrink-0">+</span>
                        <span>{item}</span>
                      </li>
                    ))}
                  </ul>
                </div>

                <!-- Limitations -->
                <div>
                  <h4 class="text-xs font-semibold text-amber-600 uppercase tracking-wider mb-2">Limitations</h4>
                  <ul class="space-y-1">
                    {model.limitations.map((item: string) => (
                      <li class="text-sm text-gray-600 flex items-start gap-2">
                        <span class="text-amber-500 font-bold flex-shrink-0">â€“</span>
                        <span>{item}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            </div>

            <!-- Toggle Button -->
            <button class="expand-btn w-full px-5 py-3 text-sm font-medium text-vibrant-600 hover:text-vibrant-700 hover:bg-vibrant-50/50 transition-all flex items-center justify-center gap-2 border-t border-gray-100">
              <span class="expand-text">Show details</span>
              <svg class="expand-icon w-4 h-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
          </article>
        ))}
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden py-16 text-center">
        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-gray-500 text-lg">No models match your filters</p>
        <button id="clear-filters" class="mt-4 text-vibrant-600 hover:text-vibrant-700 font-medium text-sm">
          Clear all filters
        </button>
      </div>
    </div>
  </section>

  <!-- Back to Tools CTA -->
  <section class="py-10 bg-white border-t border-gray-100">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <a href={`${base}tools`} class="inline-flex items-center gap-2 text-vibrant-600 hover:text-vibrant-700 font-medium transition-colors">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Tools & Projects
      </a>
    </div>
  </section>
</BaseLayout>

<script is:inline>
  // Filter state
  const activeFilters = new Set();
  let searchQuery = '';

  // DOM elements
  const searchInput = document.getElementById('search-input');
  const filterBtns = document.querySelectorAll('.filter-btn');
  const modelCards = document.querySelectorAll('.model-card');
  const resultsCount = document.getElementById('results-count');
  const emptyState = document.getElementById('empty-state');
  const modelsGrid = document.getElementById('models-grid');
  const clearFiltersBtn = document.getElementById('clear-filters');

  // Expand/collapse functionality
  document.querySelectorAll('.expand-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const card = btn.closest('.model-card');
      const panel = card ? card.querySelector('.details-panel') : null;
      const text = btn.querySelector('.expand-text');
      const icon = btn.querySelector('.expand-icon');

      if (panel && panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        if (text) text.textContent = 'Hide details';
        if (icon) icon.classList.add('rotate-180');
      } else if (panel) {
        panel.classList.add('hidden');
        if (text) text.textContent = 'Show details';
        if (icon) icon.classList.remove('rotate-180');
      }
    });
  });

  // Filter logic
  function applyFilters() {
    let visibleCount = 0;

    modelCards.forEach(function(card) {
      const name = card.getAttribute('data-name') || '';
      const vendor = card.getAttribute('data-vendor') || '';
      const isOpenWeights = card.getAttribute('data-open-weights') === 'true';
      const hasVision = card.getAttribute('data-vision') === 'true';
      const hasToolUse = card.getAttribute('data-tool-use') === 'true';
      const isLongContext = card.getAttribute('data-long-context') === 'true';

      // Check search query
      const matchesSearch = searchQuery === '' ||
        name.includes(searchQuery.toLowerCase()) ||
        vendor.includes(searchQuery.toLowerCase());

      // Check filters
      let matchesFilters = true;
      if (activeFilters.has('open_weights') && !isOpenWeights) matchesFilters = false;
      if (activeFilters.has('vision') && !hasVision) matchesFilters = false;
      if (activeFilters.has('tool_use') && !hasToolUse) matchesFilters = false;
      if (activeFilters.has('long_context') && !isLongContext) matchesFilters = false;

      if (matchesSearch && matchesFilters) {
        card.style.display = '';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // Update count
    if (resultsCount) {
      resultsCount.textContent = visibleCount + ' model' + (visibleCount !== 1 ? 's' : '');
    }

    // Show/hide empty state
    if (visibleCount === 0) {
      if (emptyState) emptyState.classList.remove('hidden');
      if (modelsGrid) modelsGrid.classList.add('hidden');
    } else {
      if (emptyState) emptyState.classList.add('hidden');
      if (modelsGrid) modelsGrid.classList.remove('hidden');
    }
  }

  // Search handler
  if (searchInput) {
    searchInput.addEventListener('input', function(e) {
      searchQuery = e.target.value;
      applyFilters();
    });
  }

  // Filter button handlers
  filterBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      const filter = btn.getAttribute('data-filter');
      if (!filter) return;

      if (activeFilters.has(filter)) {
        activeFilters.delete(filter);
        btn.classList.remove('bg-vibrant-600', 'text-white', 'border-vibrant-600');
        btn.classList.add('bg-white', 'text-gray-600', 'border-gray-200');
      } else {
        activeFilters.add(filter);
        btn.classList.add('bg-vibrant-600', 'text-white', 'border-vibrant-600');
        btn.classList.remove('bg-white', 'text-gray-600', 'border-gray-200');
      }

      applyFilters();
    });
  });

  // Clear filters
  if (clearFiltersBtn) {
    clearFiltersBtn.addEventListener('click', function() {
      activeFilters.clear();
      searchQuery = '';
      if (searchInput) searchInput.value = '';

      filterBtns.forEach(function(btn) {
        btn.classList.remove('bg-vibrant-600', 'text-white', 'border-vibrant-600');
        btn.classList.add('bg-white', 'text-gray-600', 'border-gray-200');
      });

      applyFilters();
    });
  }
</script>

<style>
  .model-card {
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .details-panel {
    animation: slideDown 0.2s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      max-height: 0;
    }
    to {
      opacity: 1;
      max-height: 500px;
    }
  }
</style>
