---
// Password protection gate - SHA-256 hash verified client-side
// To change password: update VALID_HASH in script below
// Generate hash: echo -n "yourpassword" | shasum -a 256
---

<div id="password-gate" class="fixed inset-0 z-[9999] bg-white flex items-center justify-center">
  <div class="max-w-md w-full mx-4">
    <div class="text-center mb-8">
      <img src="/images/logo-horizontal.png" alt="CUNY AI Lab" class="h-12 mx-auto mb-6" />
      <h1 class="text-2xl font-bold font-display text-neutral-stone mb-2">Protected Site</h1>
      <p class="text-gray-600">This site is currently in development. Please enter the access code to continue.</p>
    </div>

    <form id="password-form" class="space-y-4">
      <div>
        <input
          type="password"
          id="password-input"
          placeholder="Enter access code"
          autocomplete="off"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-vibrant-500 focus:border-vibrant-500 transition-all text-center text-lg tracking-widest"
        />
      </div>
      <div id="error-message" class="text-red-600 text-sm text-center hidden">
        Incorrect access code. Please try again.
      </div>
      <button
        type="submit"
        class="w-full bg-vibrant-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-vibrant-700 transition-all"
      >
        Enter Site
      </button>
    </form>

    <p class="mt-6 text-xs text-gray-400 text-center">
      Contact <a href="mailto:info@cunyailab.org" class="text-vibrant-600 hover:underline">info@cunyailab.org</a> for access.
    </p>
  </div>
</div>

<script>
  // SHA-256 hash of the password
  // To change: echo -n "newpassword" | shasum -a 256
  const VALID_HASH = '88e35da11564a8be29e5d020091ce186d05ad7ef0874ee1061b7fe70b1d6c792';

  const AUTH_KEY = 'cuny_ai_lab_auth';
  const gate = document.getElementById('password-gate');
  const form = document.getElementById('password-form');
  const input = document.getElementById('password-input') as HTMLInputElement;
  const errorMsg = document.getElementById('error-message');

  // Check if already authenticated
  async function checkAuth() {
    const storedAuth = sessionStorage.getItem(AUTH_KEY);
    if (storedAuth) {
      const isValid = await verifyHash(storedAuth);
      if (isValid) {
        gate?.classList.add('hidden');
        return;
      }
    }
    gate?.classList.remove('hidden');
    input?.focus();
  }

  // Hash password using SHA-256
  async function hashPassword(password: string): Promise<string> {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // Verify hash matches
  async function verifyHash(hash: string): Promise<boolean> {
    // Simple check - in production you'd want timing-safe comparison
    return hash === VALID_HASH;
  }

  // Handle form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const password = input?.value || '';
    const hash = await hashPassword(password);

    if (await verifyHash(hash)) {
      sessionStorage.setItem(AUTH_KEY, hash);
      gate?.classList.add('hidden');
      errorMsg?.classList.add('hidden');
    } else {
      errorMsg?.classList.remove('hidden');
      input?.select();
    }
  });

  // Run auth check on load
  checkAuth();
</script>
